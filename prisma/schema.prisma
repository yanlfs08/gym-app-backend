// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  // A linha url = env("DATABASE_URL") FOI REMOVIDA!
}

// Enums para padronização
enum Role {
  ADMIN       // Dono/Gerente da academia
  TRAINER     // Personal/Professor
  STUDENT     // Aluno
  SUPER_ADMIN // Dono do SaaS
}

enum DiscountType {
  PERCENTAGE // Ex: 10% de desconto
  FIXED      // Ex: R$ 50 de desconto
}

enum MuscleGroup {
  CHEST
  BACK
  LEGS
  SHOULDERS
  ARMS
  CORE
  CARDIO
}

enum CheckInMethod {
  QR_CODE
  GEOLOCATION
  MANUAL
}

// Crie o enum de tipos de desafio
enum ChallengeType {
  TOTAL_WEIGHT
  CHECK_INS
}

// ------------------------------------------------------
// CUPONS DE DESCONTO
// ------------------------------------------------------
model Coupon {
  id          String       @id @default(cuid())
  gymId       String
  gym         Gym          @relation(fields: [gymId], references: [id])
  
  code        String       // Ex: VERAO20, ALUNONOVO
  type        DiscountType
  value       Float        // O valor do desconto (ex: 20 se for 20%, ou 50 se for R$50)
  
  expiresAt   DateTime?    // Data de validade (Opcional)
  maxUses     Int?         // Limite de usos (Ex: os 50 primeiros ganham)
  usedCount   Int          @default(0) // Quantas vezes já foi usado
  isActive    Boolean      @default(true)
  
  payments    Payment[]    // Relação com os pagamentos que usaram este cupom
  
  createdAt   DateTime     @default(now())
  
  @@unique([gymId, code])  // O código deve ser único DENTRO da academia
  @@map("coupons")
}

// ------------------------------------------------------
// PAGAMENTOS (Atualizado)
// ------------------------------------------------------
model Payment {
  id             String    @id @default(cuid())
  studentId      String
  student        User      @relation(fields: [studentId], references: [id])
  
  referenceMonth Int
  referenceYear  Int
  
  // Valores da Cobrança
  subtotal       Float     // Valor original (Ex: 150.00)
  discountAmount Float     @default(0) // Valor do desconto em R$ (Ex: 15.00)
  total          Float     // Valor final a pagar (Ex: 135.00)
  discountReason String?   // Motivo do desconto ("Pagamento em dinheiro", "Cupom BORA10", etc)
  
  // Relação com o Cupom (Opcional)
  couponId       String?
  coupon         Coupon?   @relation(fields: [couponId], references: [id])
  
  paidAt         DateTime?
  createdAt      DateTime  @default(now())
  
  @@map("payments")
}

// ------------------------------------------------------
// MODELS PRINCIPAIS
// ------------------------------------------------------

// Modelagem SaaS: Isolamento por academia
model Gym {
  id        String   @id @default(cuid())
  name      String
  cnpj      String?  @unique
  address   String?

  latitude  Float?
  longitude Float?

  users     User[]
  exercises Exercise[]
  challenges Challenge[]
  coupons     Coupon[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  deletedAt DateTime?
  subscription  GymSubscription? 

  @@map("gyms")
}

model GymSubscription {
  id        String   @id @default(cuid())
  gymId     String   @unique
  gym       Gym      @relation(fields: [gymId], references: [id], onDelete: Cascade)
  
  planName  String   // Ex: "Plano Pro Mensal", "Plano Básico"
  price     Float    // O valor que a academia te paga (Ex: 199.90)
  status    String   // ACTIVE, OVERDUE (Atrasado), CANCELED
  
  expiresAt DateTime // Data de vencimento da próxima fatura
  
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  
  @@map("gym_subscriptions")
}

model User {
  id            String    @id @default(cuid())
  gymId         String?
  gym           Gym?      @relation(fields: [gymId], references: [id])

  name          String
  email         String    @unique
  passwordHash  String
  role          Role      @default(STUDENT)

  // Gamificação
  points        Int       @default(0)
  currentStreak Int       @default(0)

  // Relações
  workoutSheets    WorkoutSheet[] @relation("StudentSheets")
  createdSheets    WorkoutSheet[] @relation("TrainerSheets")
  assessments      PhysicalAssessment[] @relation("StudentAssessments")
  givenAssessments PhysicalAssessment[] @relation("TrainerAssessments")
  reatedChallenges       Challenge[]            @relation("CreatedChallenges")
  challengeParticipations ChallengeParticipant[] @relation("ChallengeParticipations")
  checkIns         CheckIn[]
  payments         Payment[]
  loadLogs         WorkoutLog[]
  

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  deletedAt     DateTime?

  @@index([gymId])
  @@index([email])
  @@map("users")
}

// ------------------------------------------------------
// CORE DE TREINOS
// ------------------------------------------------------

// Catálogo Global de Exercícios da Academia
model Exercise {
  id          String      @id @default(cuid())
  gymId       String
  gym         Gym         @relation(fields: [gymId], references: [id])

  name        String
  description String?
  videoUrl    String?
  muscleGroup MuscleGroup

  workoutItems WorkoutItem[]

  @@index([gymId])
  @@map("exercises")
}

// A "Ficha" principal do aluno
model WorkoutSheet {
  id          String   @id @default(cuid())
  studentId   String
  student     User     @relation("StudentSheets", fields: [studentId], references: [id])
  creatorId   String   // Pode ser o próprio aluno ou o personal
  creator     User     @relation("TrainerSheets", fields: [creatorId], references: [id])

  name        String   // Ex: "Hipertrofia - Foco Pernas"
  isActive    Boolean  @default(true)
  isPriority  Boolean  @default(false) // True se criado pelo personal

  workouts    Workout[] // As divisões (Treino A, Treino B, etc)

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([studentId])
  @@map("workout_sheets")
}

// A Divisão (Treino A, Treino B...)
model Workout {
  id            String   @id @default(cuid())
  sheetId       String
  sheet         WorkoutSheet @relation(fields: [sheetId], references: [id], onDelete: Cascade)
  name          String   // Ex: "A - Peito e Tríceps"

  items         WorkoutItem[]

  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([sheetId])
  @@map("workouts")
}

// O exercício específico dentro do Treino A
model WorkoutItem {
  id          String   @id @default(cuid())
  workoutId   String
  workout     Workout  @relation(fields: [workoutId], references: [id], onDelete: Cascade)
  exerciseId  String
  exercise    Exercise @relation(fields: [exerciseId], references: [id])

  sets        Int      // Séries
  reps        String   // Repetições (String para suportar ex: "10-12" ou "Até a falha")
  restSeconds Int      // Tempo de descanso

  logs        WorkoutLog[] // Histórico de cargas deste exercício na ficha

  @@index([workoutId])
  @@index([exerciseId])
  @@map("workout_items")
}

// Log de progressão de carga (Gamificação e Acompanhamento)
model WorkoutLog {
  id            String   @id @default(cuid())
  studentId     String
  student       User     @relation(fields: [studentId], references: [id])

  workoutItemId String
  // CORREÇÃO AQUI: Mudamos de [workoutId] para [workoutItemId]
  workoutItem   WorkoutItem @relation(fields: [workoutItemId], references: [id])

  weightUsed    Float
  notes         String?
  completedAt   DateTime @default(now())

  @@index([studentId])
  @@map("workout_logs")
}

// ------------------------------------------------------
// DESAFIOS E COMUNIDADE (CHALLENGES)
// ------------------------------------------------------

model Challenge {
  id          String   @id @default(cuid())
  gymId       String
  gym         Gym      @relation(fields: [gymId], references: [id])
  
  creatorId   String
  creator     User     @relation("CreatedChallenges", fields: [creatorId], references: [id])
  
  title       String
  description String?
  isPublic    Boolean  @default(true)
  inviteCode  String?  @unique 
  
  type        ChallengeType @default(CHECK_INS) // <-- NOVO CAMPO
  
  startDate   DateTime @default(now())
  endDate     DateTime
  
  participants ChallengeParticipant[]
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@index([gymId])
  @@map("challenges")
}

model ChallengeParticipant {
  id          String    @id @default(cuid())
  challengeId String
  challenge   Challenge @relation(fields: [challengeId], references: [id], onDelete: Cascade)
  
  studentId   String
  student     User      @relation("ChallengeParticipations", fields: [studentId], references: [id])
  
  joinedAt    DateTime  @default(now())
  
  // Um aluno não pode entrar duas vezes no mesmo desafio
  @@unique([challengeId, studentId]) 
  @@index([studentId])
  @@map("challenge_participants")
}

// ------------------------------------------------------
// AVALIAÇÃO FÍSICA E CHECK-IN
// ------------------------------------------------------

model PhysicalAssessment {
  id          String   @id @default(cuid())
  studentId   String
  student     User     @relation("StudentAssessments", fields: [studentId], references: [id])
  trainerId   String
  trainer     User     @relation("TrainerAssessments", fields: [trainerId], references: [id])

  weight      Float
  height      Float

  // Protocolo Jackson & Pollock (7 Dobras) em mm
  chestFold       Float?
  axillaryFold    Float?
  tricepsFold     Float?
  subscapularFold Float?
  abdomenFold     Float?
  suprailiacFold  Float?
  thighFold       Float?

  // Resultados calculados (serão calculados no backend Fastify)
  bodyFatPercentage Float?
  muscleMass        Float?

  date        DateTime @default(now())
  notes       String?

  @@index([studentId])
  @@map("physical_assessments")
}

model CheckIn {
  id          String   @id @default(cuid())
  studentId   String
  student     User     @relation(fields: [studentId], references: [id])
  method      CheckInMethod

  timestamp   DateTime @default(now())

  @@index([studentId])
  @@map("check_ins")
}
